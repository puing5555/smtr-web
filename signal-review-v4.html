<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ” ì½”ë¦°ì´ ì•„ë¹  ì‹œê·¸ë„ ê²€ì¦</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0f0f23;color:#e2e8f0}
.container{max-width:1200px;margin:0 auto;padding:20px}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:16px;margin-bottom:24px}
.header h1{font-size:24px;margin-bottom:8px}
.header p{opacity:.9;font-size:14px}
.opus-bar{display:flex;gap:12px;align-items:center;margin-top:12px}
.opus-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:8px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600}
.opus-btn:hover{background:rgba(255,255,255,.3)}
.opus-btn:disabled{opacity:.5;cursor:not-allowed}
.progress-bar{flex:1;height:8px;background:rgba(255,255,255,.2);border-radius:4px;overflow:hidden;display:none}
.progress-fill{height:100%;background:#4ade80;transition:width .3s}
.progress-text{font-size:13px;opacity:.9;display:none}
.stats{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
.stat-card{background:#1a1a2e;border-radius:12px;padding:16px 20px;flex:1;min-width:100px;text-align:center;border:1px solid #2d2d44}
.stat-number{font-size:28px;font-weight:700;color:#667eea}
.stat-label{font-size:12px;color:#888;margin-top:4px}
.filters{background:#1a1a2e;border-radius:12px;padding:20px;margin-bottom:24px;border:1px solid #2d2d44}
.filter-row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-label{font-size:12px;font-weight:600;color:#888}
.filter-select,.filter-input{padding:8px 12px;border:1px solid #2d2d44;border-radius:8px;font-size:14px;background:#0f0f23;color:#e2e8f0}
.signals-grid{display:flex;flex-direction:column;gap:16px}
.signal-card{background:#1a1a2e;border-radius:12px;padding:20px;border:1px solid #2d2d44;border-left:4px solid #444;transition:all .3s}
.signal-card[data-signal="STRONG_BUY"]{border-left-color:#10b981}
.signal-card[data-signal="BUY"]{border-left-color:#86efac}
.signal-card[data-signal="POSITIVE"]{border-left-color:#60a5fa}
.signal-card[data-signal="HOLD"]{border-left-color:#06b6d4}
.signal-card[data-signal="NEUTRAL"]{border-left-color:#94a3b8}
.signal-card[data-signal="CONCERN"]{border-left-color:#fdba74}
.signal-card[data-signal="SELL"]{border-left-color:#fb923c}
.signal-card[data-signal="STRONG_SELL"]{border-left-color:#f87171}
.signal-card.human-done{opacity:.6}
.signal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.signal-asset{font-size:18px;font-weight:700}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;color:#fff}
.badge.STRONG_BUY{background:#10b981}.badge.BUY{background:#86efac;color:#065f46}.badge.POSITIVE{background:#60a5fa}
.badge.HOLD{background:#06b6d4}.badge.NEUTRAL{background:#94a3b8}.badge.CONCERN{background:#fdba74;color:#7c2d12}
.badge.SELL{background:#fb923c}.badge.STRONG_SELL{background:#f87171}
.badge.conf-HIGH{background:#052e16;color:#4ade80}.badge.conf-MEDIUM{background:#422006;color:#f59e0b}.badge.conf-LOW{background:#450a0a;color:#fca5a5}
.badge.pending{background:#422006;color:#f59e0b}.badge.approved{background:#052e16;color:#4ade80}.badge.rejected{background:#450a0a;color:#fca5a5}
.badge.opus-approve{background:#052e16;color:#4ade80}.badge.opus-reject{background:#450a0a;color:#fca5a5}.badge.opus-modify{background:#422006;color:#f59e0b}
.quote{background:#0f0f23;padding:12px 16px;border-radius:8px;margin:12px 0;font-style:italic;color:#ccc;border-left:3px solid #667eea;font-size:14px;line-height:1.6}
.meta{display:flex;gap:16px;font-size:13px;color:#888;margin-top:8px;flex-wrap:wrap}
.meta a{color:#ef4444;text-decoration:none}.meta a:hover{text-decoration:underline}
.tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.tag{font-size:11px;padding:2px 8px;border-radius:10px;background:#2d2d44;color:#94a3b8}
.tag.active{background:#1e3a5f;color:#60a5fa}
.opus-result{background:#1e1e3a;border:1px solid #3d3d5c;border-radius:8px;padding:12px;margin-top:10px;font-size:13px}
.opus-result .verdict{font-weight:700;margin-bottom:4px}
.opus-result .reasoning{color:#aaa;line-height:1.5}
.summary-toggle{cursor:pointer;color:#667eea;font-size:13px;margin-top:6px}
.summary-content{display:none;margin-top:8px;font-size:13px;color:#999;line-height:1.6;padding:10px;background:#0f0f23;border-radius:6px}
.summary-content.show{display:block}
.actions{display:flex;gap:8px;align-items:center;margin-top:12px}
.btn{padding:8px 16px;border-radius:8px;border:1px solid #2d2d44;background:#1a1a2e;cursor:pointer;font-size:14px;color:#e2e8f0}
.btn:hover{background:#2d2d44}
.btn.active-approve{background:#065f46;border-color:#10b981}
.btn.active-reject{background:#7f1d1d;border-color:#ef4444}
.reject-input{display:none;margin-top:8px}
.reject-input.show{display:flex;gap:8px}
.reject-input input{flex:1;padding:6px 10px;border:1px solid #2d2d44;border-radius:6px;font-size:13px;background:#0f0f23;color:#e2e8f0}
.reject-input button{padding:6px 12px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px}
.saving{position:fixed;top:20px;right:20px;background:#667eea;color:#fff;padding:8px 16px;border-radius:8px;display:none;z-index:999;font-weight:600}
.cost-est{font-size:12px;color:#aaa;margin-left:8px}
</style>
</head>
<body>
<div class="saving" id="saving">ì €ì¥ì¤‘...</div>
<div class="container">
<div class="header">
<h1>ğŸ” ì½”ë¦°ì´ ì•„ë¹  ì‹œê·¸ë„ ê²€ì¦</h1>
<p>íŒŒì´í”„ë¼ì¸: Claude Sonnet(ì¶”ì¶œ) â†’ Opus(ê²€ì¦) â†’ ì‚¬ëŒ(ìµœì¢…)</p>
<div class="opus-bar">
<button class="opus-btn" id="opus-btn" onclick="startOpusBatch()">ğŸ§  Opus ì „ì²´ ê²€í† </button>
<span class="cost-est" id="cost-est"></span>
<div class="progress-bar" id="prog-bar"><div class="progress-fill" id="prog-fill"></div></div>
<span class="progress-text" id="prog-text"></span>
</div>
</div>
<div class="stats" id="stats"></div>
<div class="filters">
<div class="filter-row">
<div class="filter-group"><label class="filter-label">ì¢…ëª©</label><select class="filter-select" id="f-asset"><option value="">ì „ì²´</option></select></div>
<div class="filter-group"><label class="filter-label">ì‹œê·¸ë„</label><select class="filter-select" id="f-signal">
<option value="">ì „ì²´</option><option value="STRONG_BUY">ê°•ë ¥ë§¤ìˆ˜</option><option value="BUY">ë§¤ìˆ˜</option><option value="POSITIVE">ê¸ì •</option><option value="HOLD">ë³´ìœ </option><option value="NEUTRAL">ì¤‘ë¦½</option><option value="CONCERN">ìš°ë ¤</option><option value="SELL">ë§¤ë„</option><option value="STRONG_SELL">ê°•ë ¥ë§¤ë„</option>
</select></div>
<div class="filter-group"><label class="filter-label">Opus ê²°ê³¼</label><select class="filter-select" id="f-opus">
<option value="">ì „ì²´</option><option value="approve">ìŠ¹ì¸</option><option value="reject">ê±°ì ˆ</option><option value="modify">ìˆ˜ì •í•„ìš”</option><option value="none">ë¯¸ê²€í† </option>
</select></div>
<div class="filter-group"><label class="filter-label">ì‚¬ëŒ ë¦¬ë·°</label><select class="filter-select" id="f-human">
<option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="approved">ìŠ¹ì¸</option><option value="rejected">ê±°ì ˆ</option>
</select></div>
<div class="filter-group"><label class="filter-label">ê²€ìƒ‰</label><input class="filter-input" id="f-search" placeholder="ì¢…ëª©/ë‚´ìš© ê²€ìƒ‰..."></div>
</div>
</div>
<div class="signals-grid" id="grid"></div>
</div>
<script>
let SIGS=[],REVIEWS={},OPUS={};
const SL={'STRONG_BUY':'ê°•ë ¥ë§¤ìˆ˜','BUY':'ë§¤ìˆ˜','POSITIVE':'ê¸ì •','HOLD':'ë³´ìœ ','NEUTRAL':'ì¤‘ë¦½','CONCERN':'ìš°ë ¤','SELL':'ë§¤ë„','STRONG_SELL':'ê°•ë ¥ë§¤ë„'};
const VL={'approve':'âœ… ìŠ¹ì¸','reject':'âŒ ê±°ì ˆ','modify':'âš ï¸ ìˆ˜ì •í•„ìš”','error':'ğŸ’¥ ì—ëŸ¬'};

async function init(){
const[s,r,o]=await Promise.all([
fetch('/api/signals').then(r=>r.json()),
fetch('/api/reviews').then(r=>r.json()),
fetch('/api/opus-reviews').then(r=>r.json())
]);
SIGS=s;REVIEWS=r;OPUS=o;
initFilters();render();
const pending=SIGS.filter(s=>!OPUS[sid(s)]).length;
document.getElementById('cost-est').textContent=pending>0?`ë¯¸ê²€í†  ${pending}ê°œ Â· ì˜ˆìƒë¹„ìš© ~$${(pending*0.08).toFixed(1)}`:'ì „ì²´ ê²€í†  ì™„ë£Œ';
}
init();

function sid(s){return s.video_id+'_'+s.asset}
function esc(s){return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}

function parseTs(ts){
if(!ts)return null;
const p=ts.replace(/[\[\] ]/g,'').split(':');
if(p.length===2)return parseInt(p[0])*60+parseInt(p[1]);
if(p.length===3)return parseInt(p[0])*3600+parseInt(p[1])*60+parseInt(p[2]);
return null;
}

function initFilters(){
const assets=[...new Set(SIGS.map(s=>s.asset))].sort();
const af=document.getElementById('f-asset');
assets.forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;af.appendChild(o)});
['f-asset','f-signal','f-opus','f-human'].forEach(id=>document.getElementById(id).addEventListener('change',render));
document.getElementById('f-search').addEventListener('input',render);
}

function render(){
const grid=document.getElementById('grid');
const fA=document.getElementById('f-asset').value;
const fS=document.getElementById('f-signal').value;
const fO=document.getElementById('f-opus').value;
const fH=document.getElementById('f-human').value;
const fQ=document.getElementById('f-search').value.toLowerCase();
grid.innerHTML='';
let shown=0,opusApprove=0,opusReject=0,humanApprove=0,humanReject=0;

SIGS.forEach(sig=>{
const id=sid(sig);
const rev=REVIEWS[id]||{status:'pending'};
const opus=OPUS[id];
if(opus){if(opus.verdict==='approve')opusApprove++;else if(opus.verdict==='reject')opusReject++;}
if(rev.status==='approved')humanApprove++;
if(rev.status==='rejected')humanReject++;

if(fA&&sig.asset!==fA)return;
if(fS&&sig.signal_type!==fS)return;
if(fO==='none'&&opus)return;
if(fO&&fO!=='none'&&(!opus||opus.verdict!==fO))return;
if(fH&&rev.status!==(fH==='pending'?'pending':fH==='approved'?'approved':'rejected'))return;
if(fQ&&!(sig.content||'').toLowerCase().includes(fQ)&&!(sig.asset||'').toLowerCase().includes(fQ)&&!(sig.title||'').toLowerCase().includes(fQ))return;

grid.appendChild(buildCard(sig,id,rev,opus));
shown++;
});

const pending=SIGS.length-humanApprove-humanReject;
document.getElementById('stats').innerHTML=[
{n:SIGS.length,l:'ì´ ì‹œê·¸ë„',c:'#667eea'},
{n:pending,l:'ì‚¬ëŒ ëŒ€ê¸°',c:'#f59e0b'},
{n:opusApprove,l:'Opus ìŠ¹ì¸',c:'#4ade80'},
{n:opusReject,l:'Opus ê±°ì ˆ',c:'#f87171'},
{n:humanApprove,l:'ì‚¬ëŒ ìŠ¹ì¸',c:'#10b981'},
{n:humanReject,l:'ì‚¬ëŒ ê±°ì ˆ',c:'#ef4444'},
{n:shown,l:'í˜„ì¬ í‘œì‹œ',c:'#94a3b8'}
].map(s=>`<div class="stat-card"><div class="stat-number" style="color:${s.c}">${s.n}</div><div class="stat-label">${s.l}</div></div>`).join('');
}

function buildCard(sig,id,rev,opus){
const card=document.createElement('div');
card.className='signal-card'+(rev.status!=='pending'?' human-done':'');
card.dataset.signal=sig.signal_type;
const ts=parseTs(sig.timestamp);
const url=ts?`https://youtube.com/watch?v=${sig.video_id}&t=${ts}`:`https://youtube.com/watch?v=${sig.video_id}`;
const revLabel={pending:'ê²€í† ëŒ€ê¸°',approved:'ìŠ¹ì¸',rejected:'ê±°ì ˆ'}[rev.status];

let opusHtml='';
if(opus){
const vc=opus.verdict==='approve'?'opus-approve':opus.verdict==='reject'?'opus-reject':'opus-modify';
opusHtml=`<div class="opus-result"><div class="verdict"><span class="badge ${vc}">${VL[opus.verdict]||opus.verdict}</span>
${opus.correct_signal_type&&opus.correct_signal_type!==sig.signal_type?` â†’ <span class="badge ${opus.correct_signal_type}">${SL[opus.correct_signal_type]||opus.correct_signal_type}</span>`:''} 
${opus.is_actionable===false?'<span class="tag">ë¹„ì‹¤í–‰ì </span>':''}</div>
<div class="reasoning">${esc(opus.reasoning||'')}</div></div>`;
}

const tags=[];
if(sig.conditional)tags.push('ì¡°ê±´ë¶€');
if(sig.skin_in_game)tags.push('ë³¸ì¸íˆ¬ì');
if(sig.hedged)tags.push('í—·ì§€');
if(sig.timeframe)tags.push(sig.timeframe);

card.innerHTML=`
<div class="signal-header">
<div>
<span class="signal-asset">${esc(sig.asset)}</span>
<span class="badge ${sig.signal_type}">${SL[sig.signal_type]||sig.signal_type}</span>
<span class="badge conf-${sig.confidence||''}">${sig.confidence||''}</span>
<span class="badge ${rev.status}">${revLabel}</span>
${sig.upload_date?`<span style="font-size:12px;color:#aaa;margin-left:6px">ğŸ“… ${sig.upload_date}</span>`:''}
</div>
<div style="font-size:12px;color:#666">â± ${esc(sig.timestamp||'')}</div>
</div>
<div class="quote">"${esc(sig.content)}"</div>
${sig.context?`<div style="margin-top:6px;font-size:13px;color:#888">ğŸ’¡ ${esc(sig.context)}</div>`:''}
<div class="meta">
<span>ğŸ¬ <a href="${esc(url)}" target="_blank">${esc((sig.title||sig.video_id).substring(0,60))} â–¶ï¸</a></span>
<span>ğŸ™ï¸ ${esc(sig.channel||'ì½”ë¦°ì´ ì•„ë¹ ')}</span>
</div>
${tags.length?`<div class="tags">${tags.map(t=>`<span class="tag active">${t}</span>`).join('')}</div>`:''}
${sig.video_summary?`<div class="summary-toggle" onclick="this.nextElementSibling.classList.toggle('show')">ğŸ“‹ ì˜ìƒìš”ì•½ ë³´ê¸°/ì ‘ê¸°</div><div class="summary-content">${esc(sig.video_summary)}</div>`:''}
${opusHtml}
<div class="actions">
<button class="btn${rev.status==='approved'?' active-approve':''}" onclick="doReview('${id}','approved',this)">âœ… ìŠ¹ì¸</button>
<button class="btn${rev.status==='rejected'?' active-reject':''}" onclick="showReject(this)">âŒ ê±°ì ˆ</button>
${rev.status==='rejected'&&rev.reason?`<span style="color:#fca5a5;font-size:13px">â›” ${esc(rev.reason)}</span>`:''}
</div>
<div class="reject-input">
<input placeholder="ê±°ì ˆ ì‚¬ìœ ...">
<button onclick="submitReject('${id}',this)">ê±°ì ˆ</button>
</div>`;
return card;
}

function showReject(btn){
const ri=btn.closest('.signal-card').querySelector('.reject-input');
ri.classList.toggle('show');
if(ri.classList.contains('show'))ri.querySelector('input').focus();
}

async function doReview(id,status,btn){
document.getElementById('saving').style.display='block';
await fetch('/api/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,status})});
REVIEWS[id]={status,time:new Date().toISOString()};
document.getElementById('saving').style.display='none';
render();
}

async function submitReject(id,btn){
const input=btn.previousElementSibling;
const reason=input.value;
document.getElementById('saving').style.display='block';
await fetch('/api/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,status:'rejected',reason})});
REVIEWS[id]={status:'rejected',reason,time:new Date().toISOString()};
document.getElementById('saving').style.display='none';
render();
}

async function startOpusBatch(){
const btn=document.getElementById('opus-btn');
const bar=document.getElementById('prog-bar');
const fill=document.getElementById('prog-fill');
const txt=document.getElementById('prog-text');
if(!confirm('Opus ì „ì²´ ê²€í† ë¥¼ ì‹œì‘í• ê¹Œìš”? (ë¯¸ê²€í†  ì‹œê·¸ë„ë§Œ ì²˜ë¦¬)'))return;
btn.disabled=true;bar.style.display='block';txt.style.display='inline';
await fetch('/api/opus-review-all',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});

const poll=setInterval(async()=>{
const p=await fetch('/api/opus-progress').then(r=>r.json());
const pct=p.total>0?Math.round(p.done/p.total*100):0;
fill.style.width=pct+'%';
txt.textContent=`${p.done}/${p.total} (${pct}%)${p.errors?' âš ï¸'+p.errors+'ì—ëŸ¬':''}`;
if(!p.running){
clearInterval(poll);
btn.disabled=false;
txt.textContent='ì™„ë£Œ!';
const o=await fetch('/api/opus-reviews').then(r=>r.json());
OPUS=o;render();
document.getElementById('cost-est').textContent='ì „ì²´ ê²€í†  ì™„ë£Œ';
}
},2000);
}
</script>
</body>
</html>