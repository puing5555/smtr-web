<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨íŠ¸ API ì—°ë™ ë°ëª¨</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #0a0e17;
            color: #e2e8f0;
            padding: 20px;
        }
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background: #111827;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .stock-buttons {
            margin: 20px 0;
        }
        .stock-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
        }
        .stock-btn:hover {
            background: #2563eb;
        }
        .chart-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .chart-price {
            font-size: 32px;
            font-weight: bold;
        }
        .change {
            font-size: 16px;
        }
        .change.up { color: #10b981; }
        .change.down { color: #ef4444; }
        #chartDiv {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>ğŸš€ íˆ¬ì ì°¨íŠ¸ API ì—°ë™ ë°ëª¨</h1>
        <p>CoinGecko APIë¥¼ í†µí•´ ì‹¤ì œ ê°€ê²© ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œí•©ë‹ˆë‹¤.</p>
        
        <div class="stock-buttons">
            <button class="stock-btn" onclick="loadChart('ë¹„íŠ¸ì½”ì¸')">ë¹„íŠ¸ì½”ì¸</button>
            <button class="stock-btn" onclick="loadChart('ì´ë”ë¦¬ì›€')">ì´ë”ë¦¬ì›€</button>
            <button class="stock-btn" onclick="loadChart('ì†”ë¼ë‚˜')">ì†”ë¼ë‚˜</button>
            <button class="stock-btn" onclick="loadChart('XRP')">XRP</button>
            <button class="stock-btn" onclick="loadChart('ì—”ë¹„ë””ì•„')">ì—”ë¹„ë””ì•„ (ë”ë¯¸)</button>
        </div>
        
        <div class="chart-container">
            <div class="chart-title" id="chartTitle">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="chart-price" id="chartPrice">-</div>
            <div class="change" id="chartChange">-</div>
            <div id="chartDiv"></div>
        </div>
        
        <div id="status" style="margin-top: 20px; padding: 10px; background: #1a2332; border-radius: 6px;">
            <strong>ìƒíƒœ:</strong> <span id="statusText">ëŒ€ê¸° ì¤‘</span>
        </div>
    </div>

    <script>
        // ì¢…ëª©ëª… â†’ API ì‹¬ë³¼ ë§¤í•‘ í…Œì´ë¸”
        const STOCK_SYMBOLS = {
            'ë¹„íŠ¸ì½”ì¸': { type: 'crypto', id: 'bitcoin' },
            'XRP': { type: 'crypto', id: 'ripple' },
            'ì´ë”ë¦¬ì›€': { type: 'crypto', id: 'ethereum' },
            'ì†”ë¼ë‚˜': { type: 'crypto', id: 'solana' },
            'ì²´ì¸ë§í¬': { type: 'crypto', id: 'chainlink' },
            'ì—”ë¹„ë””ì•„': { type: 'stock', symbol: 'NVDA' }
        };

        // API ë°ì´í„° ìºì‹œ
        const priceDataCache = new Map();
        const CACHE_DURATION = 10 * 60 * 1000; // 10ë¶„

        let chart = null;

        // CoinGecko APIë¡œ ì½”ì¸ ê°€ê²© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchCryptoData(cryptoId, days = 90) {
            const cacheKey = `crypto_${cryptoId}_${days}`;
            const cached = priceDataCache.get(cacheKey);
            
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                updateStatus(`ìºì‹œëœ ë°ì´í„° ì‚¬ìš©: ${cryptoId}`);
                return cached.data;
            }

            updateStatus(`API í˜¸ì¶œ ì¤‘: ${cryptoId}...`);

            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${cryptoId}/ohlc?vs_currency=usd&days=${days}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const formattedData = data.map(([timestamp, open, high, low, close]) => ({
                    time: new Date(timestamp).toISOString().split('T')[0],
                    open: parseFloat(open.toFixed(8)),
                    high: parseFloat(high.toFixed(8)),
                    low: parseFloat(low.toFixed(8)),
                    close: parseFloat(close.toFixed(8))
                }));

                // ìºì‹œì— ì €ì¥
                priceDataCache.set(cacheKey, {
                    data: formattedData,
                    timestamp: Date.now()
                });

                updateStatus(`API ì„±ê³µ: ${formattedData.length}ê°œ ë°ì´í„° í¬ì¸íŠ¸`);
                return formattedData;
            } catch (error) {
                updateStatus(`API ì‹¤íŒ¨: ${error.message}`);
                console.error('CoinGecko API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ë”ë¯¸ ë°ì´í„° ìƒì„± (ì£¼ì‹ìš©)
        function generateDummyOHLC(stockName) {
            updateStatus(`ë”ë¯¸ ë°ì´í„° ìƒì„±: ${stockName}`);
            const data = [];
            const days = 90;
            
            let basePrice = stockName.includes('ì—”ë¹„ë””ì•„') ? 140 : 100;
            let currentPrice = basePrice;

            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const changeRate = (Math.random() - 0.5) * 0.08; // -4% ~ +4%
                const open = currentPrice;
                const close = open * (1 + changeRate);
                const high = Math.max(open, close) * (1 + Math.random() * 0.02);
                const low = Math.min(open, close) * (1 - Math.random() * 0.02);

                data.push({
                    time: dateStr,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2))
                });

                currentPrice = close;
            }

            return data;
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        async function loadChart(stockName) {
            updateStatus('ì°¨íŠ¸ ë¡œë”© ì¤‘...');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (chart) {
                chart.remove();
                chart = null;
            }

            const chartDiv = document.getElementById('chartDiv');
            chartDiv.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 400px;">ë¡œë”© ì¤‘...</div>';

            try {
                const symbolInfo = STOCK_SYMBOLS[stockName];
                let chartData = null;

                if (symbolInfo && symbolInfo.type === 'crypto') {
                    chartData = await fetchCryptoData(symbolInfo.id, 90);
                    
                    if (!chartData) {
                        chartData = generateDummyOHLC(stockName);
                    }
                } else {
                    chartData = generateDummyOHLC(stockName);
                }

                // ì°¨íŠ¸ ìƒì„±
                chart = LightweightCharts.createChart(chartDiv, {
                    width: chartDiv.clientWidth,
                    height: 400,
                    layout: {
                        background: { color: 'transparent' },
                        textColor: '#e2e8f0'
                    },
                    grid: {
                        vertLines: { color: '#1e293b' },
                        horzLines: { color: '#1e293b' }
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#334155',
                    },
                    timeScale: {
                        borderColor: '#334155',
                        timeVisible: true,
                    }
                });

                // ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ ì¶”ê°€
                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderUpColor: '#10b981',
                    borderDownColor: '#ef4444',
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444',
                });

                candlestickSeries.setData(chartData);

                // ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
                const latestData = chartData[chartData.length - 1];
                const prevData = chartData[chartData.length - 2];
                
                if (latestData && prevData) {
                    const change = ((latestData.close - prevData.close) / prevData.close) * 100;
                    const isUp = change >= 0;

                    document.getElementById('chartTitle').textContent = stockName;
                    document.getElementById('chartPrice').textContent = latestData.close >= 1000 ? 
                        `$${latestData.close.toLocaleString()}` : 
                        `$${latestData.close.toFixed(2)}`;
                    document.getElementById('chartChange').textContent = `${isUp ? '+' : ''}${change.toFixed(2)}%`;
                    document.getElementById('chartChange').className = `change ${isUp ? 'up' : 'down'}`;
                }

                updateStatus('ì°¨íŠ¸ ë¡œë”© ì™„ë£Œ! âœ…');

            } catch (error) {
                console.error('ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
                updateStatus(`ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${error.message}`);
                chartDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ ì°¨íŠ¸ í‘œì‹œ
        window.addEventListener('load', () => {
            loadChart('ë¹„íŠ¸ì½”ì¸');
        });
    </script>
</body>
</html>